/**
 * create-float
 * Create Float.js applications with one command
 */

import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import prompts from 'prompts';
import pc from 'picocolors';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

const banner = `
${pc.cyan('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—')}
${pc.cyan('â•‘')}  ${pc.bold(pc.magenta('âš¡ Create Float.js App'))}             ${pc.cyan('â•‘')}
${pc.cyan('â•‘')}  ${pc.dim('Ultra Modern Web Framework')}          ${pc.cyan('â•‘')}
${pc.cyan('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•')}
`;

interface Template {
  name: string;
  description: string;
  value: string;
}

const templates: Template[] = [
  { 
    name: 'Default', 
    description: 'Basic Float.js app with TypeScript',
    value: 'default',
  },
  { 
    name: 'Minimal', 
    description: 'Bare minimum setup',
    value: 'minimal',
  },
  { 
    name: 'Full Stack', 
    description: 'With API routes and database ready',
    value: 'fullstack',
  },
];

async function main() {
  console.log(banner);

  // Get project name from args or prompt
  let projectName = process.argv[2];

  if (!projectName) {
    const response = await prompts({
      type: 'text',
      name: 'projectName',
      message: 'Project name:',
      initial: 'my-float-app',
      validate: (value) => {
        if (!value) return 'Project name is required';
        if (!/^[a-z0-9-_]+$/i.test(value)) return 'Invalid project name';
        return true;
      },
    });

    if (!response.projectName) {
      console.log(pc.red('\nâŒ Project creation cancelled\n'));
      process.exit(1);
    }

    projectName = response.projectName;
  }

  // Select template
  const { template } = await prompts({
    type: 'select',
    name: 'template',
    message: 'Select a template:',
    choices: templates.map(t => ({
      title: `${t.name} ${pc.dim(`- ${t.description}`)}`,
      value: t.value,
    })),
  });

  if (!template) {
    console.log(pc.red('\nâŒ Project creation cancelled\n'));
    process.exit(1);
  }

  // Additional options
  const { typescript, tailwind, eslint } = await prompts([
    {
      type: 'confirm',
      name: 'typescript',
      message: 'Use TypeScript?',
      initial: true,
    },
    {
      type: 'confirm',
      name: 'tailwind',
      message: 'Add Tailwind CSS?',
      initial: true,
    },
    {
      type: 'confirm',
      name: 'eslint',
      message: 'Add ESLint?',
      initial: true,
    },
  ]);

  const projectDir = path.resolve(process.cwd(), projectName);

  // Check if directory exists
  if (fs.existsSync(projectDir)) {
    const { overwrite } = await prompts({
      type: 'confirm',
      name: 'overwrite',
      message: `Directory ${projectName} already exists. Overwrite?`,
      initial: false,
    });

    if (!overwrite) {
      console.log(pc.red('\nâŒ Project creation cancelled\n'));
      process.exit(1);
    }

    fs.rmSync(projectDir, { recursive: true });
  }

  console.log(pc.cyan(`\nðŸ“ Creating project in ${pc.bold(projectDir)}...\n`));

  // Create project structure
  createProject(projectDir, {
    name: projectName,
    template,
    typescript,
    tailwind,
    eslint,
  });

  // Success message
  console.log(pc.green('\nâœ… Project created successfully!\n'));
  console.log(pc.bold('Next steps:\n'));
  console.log(`  ${pc.cyan('cd')} ${projectName}`);
  console.log(`  ${pc.cyan('pnpm')} install ${pc.dim('# or npm install')}`);
  console.log(`  ${pc.cyan('pnpm')} dev ${pc.dim('# or npm run dev')}`);
  console.log('');
  console.log(pc.dim('Happy coding with Float.js! âš¡\n'));
}

interface ProjectOptions {
  name: string;
  template: string;
  typescript: boolean;
  tailwind: boolean;
  eslint: boolean;
}

function createProject(projectDir: string, options: ProjectOptions) {
  const { name, typescript, tailwind, eslint } = options;
  const ext = typescript ? 'tsx' : 'jsx';

  fs.mkdirSync(projectDir, { recursive: true });

  // Create package.json
  const packageJson = {
    name,
    version: '2.0.3',
    private: true,
    type: 'module',
    scripts: {
      dev: 'float dev',
      build: 'float build',
      start: 'float start',
      lint: eslint ? 'eslint . --ext .ts,.tsx' : undefined,
    },
    dependencies: {
      '@float.js/core': '^2.0.3',
      react: '^18.2.0',
      'react-dom': '^18.2.0',
    },
    devDependencies: {
      ...(typescript && {
        typescript: '^5.3.0',
        '@types/react': '^18.2.0',
        '@types/react-dom': '^18.2.0',
        '@types/node': '^20.10.0',
      }),
      ...(tailwind && {
        tailwindcss: '^3.4.0',
        autoprefixer: '^10.4.0',
        postcss: '^8.4.0',
      }),
      ...(eslint && {
        eslint: '^8.56.0',
        '@typescript-eslint/eslint-plugin': '^6.0.0',
        '@typescript-eslint/parser': '^6.0.0',
      }),
    },
  };

  // Remove undefined values
  Object.keys(packageJson.scripts).forEach(key => {
    if ((packageJson.scripts as any)[key] === undefined) {
      delete (packageJson.scripts as any)[key];
    }
  });

  fs.writeFileSync(
    path.join(projectDir, 'package.json'),
    JSON.stringify(packageJson, null, 2)
  );

  // Create TypeScript config
  if (typescript) {
    const tsconfig = {
      compilerOptions: {
        target: 'ES2022',
        lib: ['dom', 'dom.iterable', 'esnext'],
        allowJs: true,
        skipLibCheck: true,
        strict: true,
        noEmit: true,
        esModuleInterop: true,
        module: 'esnext',
        moduleResolution: 'bundler',
        resolveJsonModule: true,
        isolatedModules: true,
        jsx: 'react-jsx',
        incremental: true,
        paths: {
          '@/*': ['./app/*'],
        },
      },
      include: ['**/*.ts', '**/*.tsx'],
      exclude: ['node_modules'],
    };

    fs.writeFileSync(
      path.join(projectDir, 'tsconfig.json'),
      JSON.stringify(tsconfig, null, 2)
    );
  }

  // Create float.config.ts
  const floatConfig = typescript
    ? `import type { FloatConfig } from '@float/core';

const config: FloatConfig = {
  reactStrictMode: true,
};

export default config;
`
    : `/** @type {import('@float/core').FloatConfig} */
const config = {
  reactStrictMode: true,
};

export default config;
`;

  fs.writeFileSync(
    path.join(projectDir, typescript ? 'float.config.ts' : 'float.config.js'),
    floatConfig
  );

  // Create app directory
  const appDir = path.join(projectDir, 'app');
  fs.mkdirSync(appDir, { recursive: true });

  // Create root layout
  const layoutContent = typescript
    ? `import type { ReactNode } from 'react';
import type { Metadata } from '@float/core';

export const metadata: Metadata = {
  title: {
    default: '${name}',
    template: '%s | ${name}',
  },
  description: 'Built with Float.js - Ultra Modern Web Framework',
};

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
`
    : `
export const metadata = {
  title: {
    default: '${name}',
    template: '%s | ${name}',
  },
  description: 'Built with Float.js - Ultra Modern Web Framework',
};

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  );
}
`;

  fs.writeFileSync(path.join(appDir, `layout.${ext}`), layoutContent);

  // Create Float.js Welcome Home Page
  const pageContent = `export default function HomePage() {
  return (
    <>
      <style jsx>{\`
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          background: #ffffff;
          color: #0a0a0a;
          -webkit-font-smoothing: antialiased;
          line-height: 1.6;
        }
        
        .header {
          border-bottom: 1px solid #e5e7eb;
          background: #ffffff;
          position: sticky;
          top: 0;
          z-index: 50;
          backdrop-filter: blur(8px);
        }
        .header-content {
          max-width: 1280px;
          margin: 0 auto;
          padding: 20px 24px;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        .logo {
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 24px;
          font-weight: 700;
          color: #0a0a0a;
          text-decoration: none;
        }
        .logo svg {
          width: 32px;
          height: 32px;
        }
        .nav {
          display: flex;
          gap: 32px;
          align-items: center;
        }
        .nav a {
          color: #6b7280;
          text-decoration: none;
          font-size: 14px;
          font-weight: 500;
          transition: color 0.2s;
        }
        .nav a:hover {
          color: #0a0a0a;
        }
        .github-btn {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          background: #0a0a0a;
          color: #ffffff;
          border-radius: 6px;
          font-size: 14px;
          font-weight: 500;
          text-decoration: none;
          transition: background 0.2s;
        }
        .github-btn:hover {
          background: #1a1a1a;
        }
        .github-btn svg {
          width: 16px;
          height: 16px;
        }
        
        .container { max-width: 1280px; margin: 0 auto; padding: 40px 24px; }
        
        .hero { text-align: center; padding: 60px 0 80px; }
        .hero h1 { 
          font-size: clamp(48px, 8vw, 80px); 
          font-weight: 800; 
          margin-bottom: 24px;
          background: linear-gradient(135deg, #fff 0%, #6366f1 50%, #8b5cf6 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          letter-spacing: -0.02em;
        }
        .hero p { 
          font-size: 20px; 
          color: #a3a3a3; 
          max-width: 600px; 
          margin: 0 auto 40px;
          line-height: 1.6;
        }
        
        .badge {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          background: rgba(99, 102, 241, 0.1);
          border: 1px solid rgba(99, 102, 241, 0.3);
          border-radius: 100px;
          font-size: 14px;
          font-weight: 500;
          color: #a5b4fc;
          margin-bottom: 32px;
        }
        .badge::before {
          content: '';
          width: 6px;
          height: 6px;
          background: #6366f1;
          border-radius: 50%;
          animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
        
        .cards { 
          display: grid; 
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
          gap: 24px; 
          margin-bottom: 60px;
        }
        
        .card {
          position: relative;
          background: linear-gradient(135deg, rgba(17, 17, 17, 0.8), rgba(10, 10, 10, 0.8));
          border: 1px solid rgba(255, 255, 255, 0.05);
          border-radius: 16px;
          padding: 32px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          overflow: hidden;
        }
        .card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
          opacity: 0;
          transition: opacity 0.3s;
        }
        .card:hover {
          transform: translateY(-4px);
          border-color: rgba(99, 102, 241, 0.3);
          box-shadow: 0 20px 40px rgba(99, 102, 241, 0.1);
        }
        .card:hover::before { opacity: 1; }
        
        .card-icon {
          width: 48px;
          height: 48px;
          background: linear-gradient(135deg, #6366f1, #8b5cf6);
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
          font-size: 24px;
        }
        
        .card h3 {
          font-size: 20px;
          font-weight: 600;
          margin-bottom: 12px;
          color: #fff;
        }
        
        .card p {
          font-size: 15px;
          line-height: 1.6;
          color: #a3a3a3;
          margin-bottom: 20px;
        }
        
        .card-link {
          display: inline-flex;
          align-items: center;
          gap: 8px;
          color: #6366f1;
          font-size: 14px;
          font-weight: 500;
          text-decoration: none;
          transition: gap 0.2s;
        }
        .card-link:hover { gap: 12px; }
        .card-link svg {
          width: 16px;
          height: 16px;
        }
        
        .code-section {
          background: rgba(10, 10, 10, 0.6);
          border: 1px solid rgba(255, 255, 255, 0.05);
          border-radius: 16px;
          padding: 32px;
          margin-bottom: 60px;
        }
        .code-section h2 {
          font-size: 24px;
          font-weight: 600;
          margin-bottom: 20px;
        }
        
        .code {
          background: #000;
          border-radius: 12px;
          padding: 24px;
          font-family: 'Monaco', 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.8;
          overflow-x: auto;
          border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .code .line { display: flex; }
        .code .num { 
          color: #525252; 
          width: 40px; 
          user-select: none; 
          text-align: right;
          padding-right: 16px;
        }
        .code .keyword { color: #c792ea; }
        .code .string { color: #c3e88d; }
        .code .func { color: #82aaff; }
        .code .comment { color: #676e95; }
        
        .footer {
          text-align: center;
          padding: 60px 0 40px;
          color: #525252;
          font-size: 14px;
          border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .footer-links {
          display: flex;
          justify-content: center;
          gap: 32px;
          margin-bottom: 20px;
        }
        .footer-link {
          color: #a3a3a3;
          text-decoration: none;
          transition: color 0.2s;
        }
        .footer-link:hover { color: #6366f1; }
      \`}</style>
      
      <div className="container">
        <div className="hero">
          <div className="badge">
            <span>Project created successfully</span>
          </div>
          <h1>Float.js</h1>
          <p>The Ultra Modern Web Framework for building lightning-fast React applications with zero configuration</p>
        </div>
        
        <div className="cards">
          <div className="card">
            <div className="card-icon">ðŸ“š</div>
            <h3>Documentation</h3>
            <p>Learn how to build amazing applications with Float.js</p>
            <a href="https://github.com/float-js/float.js#readme" target="_blank" className="card-link">
              Read docs
              <svg viewBox="0 0 16 16" fill="currentColor">
                <path d="M6 3l6 5-6 5V3z"/>
              </svg>
            </a>
          </div>
          
          <div className="card">
            <div className="card-icon">âš¡</div>
            <h3>Examples</h3>
            <p>Explore real-world examples and starter templates</p>
            <a href="https://github.com/float-js/float.js/tree/main/examples" target="_blank" className="card-link">
              Browse examples
              <svg viewBox="0 0 16 16" fill="currentColor">
                <path d="M6 3l6 5-6 5V3z"/>
              </svg>
            </a>
          </div>
          
          <div className="card">
            <div className="card-icon">ðŸš€</div>
            <h3>Deploy</h3>
            <p>Deploy your Float.js app to production in minutes</p>
            <a href="https://github.com/float-js/float.js#deployment" target="_blank" className="card-link">
              Learn deployment
              <svg viewBox="0 0 16 16" fill="currentColor">
                <path d="M6 3l6 5-6 5V3z"/>
              </svg>
            </a>
          </div>
        </div>
        
        <div className="code-section">
          <h2>Get Started</h2>
          <div className="code">
            <div className="line">
              <span className="num">1</span>
              <span><span className="comment"># Start development server</span></span>
            </div>
            <div className="line">
              <span className="num">2</span>
              <span><span className="keyword">npx</span> <span className="func">float</span> <span className="string">dev</span></span>
            </div>
            <div className="line"><span className="num">3</span><span></span></div>
            <div className="line">
              <span className="num">4</span>
              <span><span className="comment"># Build for production</span></span>
            </div>
            <div className="line">
              <span className="num">5</span>
              <span><span className="keyword">npx</span> <span className="func">float</span> <span className="string">build</span></span>
            </div>
            <div className="line"><span className="num">6</span><span></span></div>
            <div className="line">
              <span className="num">7</span>
              <span><span className="comment"># Start production server</span></span>
            </div>
            <div className="line">
              <span className="num">8</span>
              <span><span className="keyword">npx</span> <span className="func">float</span> <span className="string">start</span></span>
            </div>
          </div>
        </div>
        
        <div className="footer">
          <div className="footer-links">
            <a href="https://github.com/float-js/float.js" target="_blank" className="footer-link">GitHub</a>
            <a href="https://www.npmjs.com/package/@float.js/core" target="_blank" className="footer-link">npm</a>
            <a href="https://github.com/float-js/float.js/issues" target="_blank" className="footer-link">Issues</a>
          </div>
          <p>Built with Float.js â€” Edit <strong>app/page.tsx</strong> to get started</p>
        </div>
      </div>
    </>
  );
}
`;

  fs.writeFileSync(path.join(appDir, `page.${ext}`), pageContent);

  // Create Tailwind files if enabled
  if (tailwind) {
    const globalsCss = `@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --foreground-rgb: 0, 0, 0;
  --background-rgb: 255, 255, 255;
}

@media (prefers-color-scheme: dark) {
  :root {
    --foreground-rgb: 255, 255, 255;
    --background-rgb: 10, 10, 10;
  }
}

body {
  color: rgb(var(--foreground-rgb));
  background: rgb(var(--background-rgb));
}
`;

    fs.writeFileSync(path.join(appDir, 'globals.css'), globalsCss);

    const tailwindConfig = `/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx}',
    './components/**/*.{js,ts,jsx,tsx}',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
`;

    fs.writeFileSync(path.join(projectDir, 'tailwind.config.js'), tailwindConfig);

    const postcssConfig = `module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
`;

    fs.writeFileSync(path.join(projectDir, 'postcss.config.js'), postcssConfig);
  }

  // Create public directory
  fs.mkdirSync(path.join(projectDir, 'public'), { recursive: true });

  // Create .gitignore
  const gitignore = `# Dependencies
node_modules/

# Build
.float/
dist/

# IDE
.vscode/
.idea/

# OS
.DS_Store

# Env
.env
.env.local
`;

  fs.writeFileSync(path.join(projectDir, '.gitignore'), gitignore);

  // Create README
  const readme = `# ${name}

Built with [Float.js](https://github.com/float/float.js) - Ultra Modern Web Framework

## Getting Started

\`\`\`bash
# Install dependencies
pnpm install

# Start development server
pnpm dev

# Build for production
pnpm build

# Start production server
pnpm start
\`\`\`

## Learn More

- [Float.js Documentation](https://float.js.org/docs)
- [Examples](https://github.com/float/float.js/tree/main/examples)
`;

  fs.writeFileSync(path.join(projectDir, 'README.md'), readme);
}

main().catch(console.error);
